<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.62.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>iOS 无卡顿同时使用圆角、阴影和边框&nbsp;&ndash;&nbsp;&#xF8FF;页面仔的笔记</title><link rel=stylesheet href=/css/core.min.738b7a5282a449bb662c82165450e3e132bd703753fde9a40fb6716b3e6f422e55b646a5d3f49c074b79879d61d47e28.css integrity=sha384-c4t6UoKkSbtmLIIWVFDj4TK9cDdT/emkD7Zxaz5vQi5Vtkal0/ScB0t5h51h1H4o><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#00a300"><meta name=theme-color content="#ffffff"><body><div class=base-body><section id=header class="site header max-body-width"><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/apple-touch-icon.png alt><span class="site name">&#xF8FF;页面仔的笔记</span></a></span>
<span class="header right-side"><a class="nav item" href=/pages/about/><span class="iconfont icon-aboutus"></span>&nbsp;About</a>
<a class="nav item" href=https://github.com/cntrump target=_blank><span class="iconfont icon-logo_github"></span>&nbsp;Github</a></span></div><div class="site slogan"><span class=title>~ 需求使我快乐 ~</span></div></section><div id=content class=max-body-width><section class="article header"><h1 class="article title">iOS 无卡顿同时使用圆角、阴影和边框</h1><p class="article date">Jan 11, 2020<span class=reading-time> • 预计阅读时间 1 分钟</span></p></section><article class="article markdown-body" style=text-align:justify><blockquote><p>在 iOS 开发中，最怕看到设计稿里圆角、阴影和边框同时出现，这三兄弟简直就是性能杀手。</p></blockquote><p>优化的方法百度一下有很多，虽然方法不同但是原理都一样。</p><p>分享一个我自己一直使用的方法：在一个 View 里只应用一种效果，然后通过组合的方式达到效果。</p><div class=highlight><pre class=chroma><code class=language-objc data-lang=objc><span class=n>override</span> <span class=nf>init</span><span class=p>(</span><span class=nl>frame</span><span class=p>:</span> <span class=n>CGRect</span><span class=p>)</span> <span class=p>{</span>
    <span class=nb>super</span><span class=p>.</span><span class=n>init</span><span class=p>(</span><span class=nl>frame</span><span class=p>:</span> <span class=n>frame</span><span class=p>)</span>

    <span class=n>imageView</span> <span class=o>=</span> <span class=n>UIImageView</span><span class=p>(</span><span class=nl>image</span><span class=p>:</span> <span class=n>UIImage</span><span class=p>(</span><span class=nl>named</span><span class=p>:</span> <span class=sa></span><span class=s>&#34;</span><span class=s>img</span><span class=s>&#34;</span><span class=p>)</span><span class=p>)</span>
    <span class=n>imageView</span><span class=p>.</span><span class=n>layer</span><span class=p>.</span><span class=n>cornerRadius</span> <span class=o>=</span> <span class=mi>14</span>
    <span class=n>imageView</span><span class=p>.</span><span class=n>layer</span><span class=p>.</span><span class=n>masksToBounds</span> <span class=o>=</span> <span class=nb>true</span>
    <span class=n>backgroundView</span> <span class=o>=</span> <span class=n>imageView</span>

    <span class=n>shadowView</span> <span class=o>=</span> <span class=n>ShadowView</span><span class=p>(</span><span class=p>)</span>
    <span class=n>shadowView</span><span class=p>.</span><span class=n>layer</span><span class=p>.</span><span class=n>cornerRadius</span> <span class=o>=</span> <span class=mi>20</span>
    <span class=n>shadowView</span><span class=p>.</span><span class=n>applyShadow</span><span class=p>(</span><span class=p>.</span><span class=n>black</span><span class=p>,</span> <span class=n>CGSize</span><span class=p>(</span><span class=nl>width</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nl>height</span><span class=p>:</span> <span class=mi>15</span><span class=p>)</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mi>40</span><span class=p>)</span>
    <span class=n>insertSubview</span><span class=p>(</span><span class=n>shadowView</span><span class=p>,</span> <span class=nl>belowSubview</span><span class=p>:</span> <span class=n>imageView</span><span class=p>)</span>

    <span class=n>contentView</span><span class=p>.</span><span class=n>layer</span><span class=p>.</span><span class=n>cornerRadius</span> <span class=o>=</span> <span class=mi>14</span>
    <span class=n>contentView</span><span class=p>.</span><span class=n>layer</span><span class=p>.</span><span class=n>borderWidth</span> <span class=o>=</span> <span class=mi>1</span>
    <span class=n>contentView</span><span class=p>.</span><span class=n>layer</span><span class=p>.</span><span class=n>borderColor</span> <span class=o>=</span> <span class=n>UIColor</span><span class=p>.</span><span class=n>orange</span><span class=p>.</span><span class=n>cgColor</span>
    <span class=n>contentView</span><span class=p>.</span><span class=n>layer</span><span class=p>.</span><span class=n>masksToBounds</span> <span class=o>=</span> <span class=nb>true</span>
<span class=p>}</span>
</code></pre></div><p><span class=image-container><span class=link><a target=_blank rel="noopener noreferrer" href=01.png><img class=img src=01.png alt></a></span><span class=caption><span class=title>生成的视图结构</span></span></span></p><p>层次结构：</p><ul><li><p><code>contentView</code>： 描绘边框，放在最上层。</p></li><li><p><code>imageView</code>： 显示圆角，放在中间，用于背景图。</p></li><li><p><code>shadowView</code>： 显示阴影，放在最底层。代码很简单，只是封装了一下阴影参数：</p><div class=highlight><pre class=chroma><code class=language-swift data-lang=swift><span class=kd>class</span> <span class=nc>ShadowView</span><span class=p>:</span> <span class=n>UIView</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>var</span> <span class=nv>shadowColor</span><span class=p>:</span> <span class=n>UIColor</span><span class=p>?</span>
    <span class=kd>private</span> <span class=kd>var</span> <span class=nv>shadowOpacity</span><span class=p>:</span> <span class=n>CGFloat</span> <span class=p>=</span> <span class=mi>1</span>
    <span class=kd>private</span> <span class=kd>var</span> <span class=nv>shadowOffset</span><span class=p>:</span> <span class=n>CGSize</span> <span class=p>=</span> <span class=n>CGSize</span><span class=p>(</span><span class=n>width</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=n>height</span><span class=p>:</span> <span class=mi>3</span><span class=p>)</span>
    <span class=kd>private</span> <span class=kd>var</span> <span class=nv>shadowBlur</span><span class=p>:</span> <span class=n>CGFloat</span> <span class=p>=</span> <span class=mi>6</span>

    <span class=kr>override</span> <span class=kd>func</span> <span class=nf>layoutSubviews</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
        <span class=kc>super</span><span class=p>.</span><span class=n>layoutSubviews</span><span class=p>(</span><span class=p>)</span>

        <span class=n>updateShadow</span><span class=p>(</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=kd>func</span> <span class=nf>applyShadow</span><span class=p>(</span><span class=kc>_</span> <span class=n>color</span><span class=p>:</span> <span class=n>UIColor</span><span class=p>?</span><span class=p>,</span> <span class=kc>_</span> <span class=n>offset</span><span class=p>:</span> <span class=n>CGSize</span><span class=p>,</span> <span class=kc>_</span> <span class=n>opacity</span><span class=p>:</span> <span class=n>CGFloat</span><span class=p>,</span> <span class=kc>_</span> <span class=n>blur</span><span class=p>:</span> <span class=n>CGFloat</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>shadowColor</span> <span class=p>=</span> <span class=n>color</span>
        <span class=n>shadowOffset</span> <span class=p>=</span> <span class=n>offset</span>
        <span class=n>shadowOpacity</span> <span class=p>=</span> <span class=n>opacity</span>
        <span class=n>shadowBlur</span> <span class=p>=</span> <span class=n>blur</span>

        <span class=n>updateShadow</span><span class=p>(</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kd>func</span> <span class=nf>updateShadow</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>layer</span><span class=p>.</span><span class=n>shadowColor</span> <span class=p>=</span> <span class=n>shadowColor</span><span class=p>?</span><span class=p>.</span><span class=n>cgColor</span>
        <span class=n>layer</span><span class=p>.</span><span class=n>shadowOffset</span> <span class=p>=</span> <span class=n>shadowOffset</span>
        <span class=n>layer</span><span class=p>.</span><span class=n>shadowOpacity</span> <span class=p>=</span> <span class=nb>Float</span><span class=p>(</span><span class=n>shadowOpacity</span><span class=p>)</span>
        <span class=n>layer</span><span class=p>.</span><span class=n>shadowRadius</span> <span class=p>=</span> <span class=n>shadowBlur</span> <span class=o>*</span> <span class=mf>0.5</span>
        <span class=n>layer</span><span class=p>.</span><span class=n>shadowPath</span> <span class=p>=</span> <span class=n>UIBezierPath</span><span class=p>(</span><span class=n>roundedRect</span><span class=p>:</span> <span class=kc>self</span><span class=p>.</span><span class=n>bounds</span><span class=p>,</span> <span class=n>cornerRadius</span><span class=p>:</span> <span class=n>layer</span><span class=p>.</span><span class=n>cornerRadius</span><span class=p>)</span><span class=p>.</span><span class=n>cgPath</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li></ul><p>分开单独绘制速度很快，使用 <code>UICollectionView</code> 进行滚动测试，生成的 Cell 数量是 1 万个。</p><p>测试机器是 <code>5s</code> + <code>iOS 12.4.4</code>，快速滑动无任何卡顿。</p><p>给一个测试 demo 大家体验一下：</p><p><a href=https://github.com/cntrump/shadow_view_demo>https://github.com/cntrump/shadow_view_demo</a></p></article><section class="article labels"><a class="article tag" href=/tags/ios/><span class=hashtag>#</span>iOS</a></section><p style=margin-bottom:20px;text-align:center;font-size:12px;color:inherit;opacity:.4><span>~ END ~</span></p><section class="article navigation"><p><a class=link href=/posts/2020/01/11_macos_httpserver/><span class=li></span>macOS 上开启内置的 HTTP Server</a class="link"></p></section></div><section id=footer class="footer max-body-width"><div class=footer-wrap><p class=copyright>&copy;2019 LayoutBoy.</p><p class=powerby><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-155172933-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>